# Development Notes - November 26, 2025

## Summary

Added network error retry logic with exponential backoff to handle transient network failures like "socket hang up", "ECONNRESET", and "ETIMEDOUT".

---

## =' Network Error Retry Logic

### Problem

User reported uncaught `AxonError: socket hang up` when calling `getLocalPath()`. The existing `withRetry()` method only handled HTTP 401 errors, but network errors bypassed retry logic entirely.

**Error Flow (Before):**
```
axios-fluent ’ "socket hang up" (network error, not AxonError with status)
    “
BoxAPI.withRetry ’ checks: error instanceof AxonError && error.status === 401
    “
Condition is FALSE ’ calls enhanceError() ’ rethrows unchanged
    “
Uncaught exception propagates to caller
```

### Solution

Extended `withRetry()` to detect and retry transient network errors with exponential backoff.

**Files Modified:**

1. `src/types.ts` - Added retry configuration options to `BoxConfig`
   - `maxRetries?: number` (default: 3)
   - `retryDelay?: number` (default: 1000ms)

2. `src/BoxAPI.ts` - Core retry logic implementation
   - Added `maxRetries` and `retryDelay` class properties
   - Added `isNetworkError()` helper to detect transient errors
   - Added `sleep()` helper for delay between retries
   - Updated `withRetry()` to handle network errors with exponential backoff

3. `src/BoxAPI.test.ts` - Added tests for retry configuration

---

## =á Network Errors Detected

The `isNetworkError()` helper detects these transient errors:

| Error | Cause |
|-------|-------|
| `socket hang up` | Connection closed unexpectedly |
| `ECONNRESET` | Connection reset by peer |
| `ETIMEDOUT` | Connection timed out |
| `ECONNREFUSED` | Connection refused (server not accepting) |
| `ENOTFOUND` | DNS lookup failed |
| `network` | Generic network-related errors |

---

## =Ý Implementation Details

### New Helper Methods

```typescript
// Detect transient network errors
private isNetworkError(error: unknown): boolean {
  if (error instanceof Error) {
    const message = error.message.toLowerCase();
    return (
      message.includes('socket hang up') ||
      message.includes('econnreset') ||
      message.includes('etimedout') ||
      message.includes('econnrefused') ||
      message.includes('enotfound') ||
      message.includes('network')
    );
  }
  return false;
}

// Sleep helper for retry delays
private sleep(ms: number): Promise<void> {
  return new Promise((resolve) => setTimeout(resolve, ms));
}
```

### Updated `withRetry()` Method

```typescript
private async withRetry<T>(operation: () => Promise<T>): Promise<T> {
  let lastError: unknown;

  for (let attempt = 0; attempt <= this.maxRetries; attempt++) {
    try {
      return await operation();
    } catch (error: unknown) {
      lastError = error;

      // Handle 401 errors (existing logic)
      if (error instanceof AxonError && error.status === 401 && !this.isRetrying) {
        // ... token refresh logic
      }

      // Handle network errors with exponential backoff
      if (this.isNetworkError(error) && attempt < this.maxRetries) {
        const delay = this.retryDelay * Math.pow(2, attempt);
        console.warn(`Network error (attempt ${attempt + 1}/${this.maxRetries + 1}), retrying in ${delay}ms...`);
        await this.sleep(delay);
        continue;
      }

      break;
    }
  }

  throw this.enhanceError(lastError);
}
```

---

## <¯ Retry Behavior

- **Default:** 3 retries with exponential backoff
- **Delays:** 1s ’ 2s ’ 4s (doubles each attempt)
- **Configurable:** Via `BoxConfig.maxRetries` and `BoxConfig.retryDelay`

**Example Configuration:**
```typescript
const box = new Box({
  maxRetries: 5,    // optional, default: 3
  retryDelay: 2000, // optional, default: 1000ms
  // ... other config
});
```

**Console Output on Network Error:**
```
Network error (attempt 1/4), retrying in 1000ms...
Network error (attempt 2/4), retrying in 2000ms...
Network error (attempt 3/4), retrying in 4000ms...
```

---

## =Ê Testing & Validation

-  `npm run typecheck` - No errors
-  `npm run build` - Success
-  Backward compatible - No breaking changes

---

## =Â Files Changed

| File | Changes |
|------|---------|
| `src/types.ts` | Added `maxRetries` and `retryDelay` to `BoxConfig` |
| `src/BoxAPI.ts` | Added `isNetworkError()`, `sleep()`, updated `withRetry()` |
| `src/BoxAPI.test.ts` | Added tests for retry configuration |

---

## <¯ Impact

### For Users

1. **Reliability:** Transient network errors no longer cause immediate failures
2. **Configurability:** Can adjust retry behavior via config
3. **Visibility:** Console warnings show retry progress

### For Codebase

1. **Resilience:** Handles flaky network connections gracefully
2. **Consistency:** Same retry pattern for both 401 and network errors
3. **Maintainability:** Clear separation of error detection logic
