# Development Notes - 2025-11-16

## Major Refactor: 3-Layer Architecture

### Overview

Completed a comprehensive refactor of the Box integration library from a monolithic class into a clean, modular 3-layer architecture.

### Architecture Changes

**Previous Structure:**

- Single `Box.ts` file with mixed responsibilities
- Direct Playwright dependencies
- Hardcoded configuration values
- No separation between API calls and local filesystem operations

**New Structure:**

```
BoxAPI (Layer 1: Pure API)
  |
  v
BoxDrive (Layer 2: Sync Bridge)
  |
  v
BoxFS (Layer 3: High-level Interface)
```

### New Files Created

1. **`types.ts`** - Enhanced type definitions
   - Added `BoxConfig` with comprehensive configuration options
   - Added `SyncStrategy` type (`'poll' | 'smart' | 'force'`)
   - Added `SyncStatus` interface for sync verification results

2. **`BoxAPI.ts`** - Pure Box REST API wrapper
   - Clean separation of authentication logic
   - No Box Drive dependencies
   - Token management (OAuth, refresh, storage)
   - All core API operations (files, folders, webhooks, shared links)
   - Automatic chunked upload for files >20MB

3. **`BoxDrive.ts`** - Box Drive sync bridge
   - Platform-specific Box Drive root detection (Windows/Mac/Linux)
   - ID-to-local-path conversion
   - Three sync strategies:
     - `poll`: Simple file existence check
     - `smart`: File size verification (default, recommended)
     - `force`: Attempt to trigger Box Drive sync
   - Box Drive health check
   - Smart sync verification with timeout/interval configuration

4. **`BoxFS.ts`** - High-level filesystem-like API
   - fs-like interface (`readDir`, `readFile`, `writeFile`)
   - Sync-aware operations (optional `ensureSync` parameter)
   - Intelligent search and find operations
   - Date-based folder structures with locale support
   - Composition of BoxAPI + BoxDrive

5. **`utils.ts`** - Utility functions
   - `formatDateFolders()` - Locale-aware date formatting
   - `getBoxOfficeOnlineUrl()` - Generate Office Online URLs
   - File type detection helpers

6. **`Box.ts`** (refactored) - Backward compatibility wrapper
   - Extends BoxFS for legacy support
   - Maintains all existing method signatures
   - Deprecated annotations for old methods
   - Zero breaking changes for existing code

### Key Improvements

#### 1. Configuration System

All previously hardcoded values are now configurable:

- `boxDriveRoot` - Auto-detected by platform, overridable
- `domain` - Configurable Box domain (e.g., 'app.box.com', enterprise domains)
- `locale` - Affects date folder formatting ('en-US', 'ja-JP', etc.)
- `syncTimeout` / `syncInterval` - Customizable sync behavior

#### 2. Token Provider Pattern

Maintained and enhanced the token provider injection:

```typescript
const box = new BoxFS({
  tokenProvider: async (callback) => {
    return await Playwright.getBoxCode(callback);
  },
});
```

#### 3. Improved Sync Verification

**Old approach:**

- Simple timeout polling for file existence
- No verification of actual sync completion
- Fixed timeout/interval values

**New approach:**

- Three strategies (`poll`, `smart`, `force`)
- Smart strategy verifies file size matches cloud metadata
- Checks if Box Drive is actually running
- Configurable timeout and interval
- Better error handling and status reporting

#### 4. ID-Based Operations

Consistent API design:

- All public methods accept Box IDs
- Internal conversion from ID to local path
- No local paths exposed in public API (except explicit `getLocalPath()`)

#### 5. Clean Separation of Concerns

- **BoxAPI**: Only knows about Box REST API
- **BoxDrive**: Only knows about Box Drive sync and path conversion
- **BoxFS**: Composes both for high-level operations

### Migration Path

**Backward Compatible (No changes needed):**

```typescript
import box from 'fs-box-sync';
await box.uploadFile('folder-id', './file.pdf');
```

**Recommended New Usage:**

```typescript
import { BoxFS } from 'fs-box-sync';
const box = new BoxFS({
  boxDriveRoot: 'C:/Users/Name/Box',
  domain: 'app.box.com',
  locale: 'en-US',
});
await box.uploadWithYearMonthFolders('folder-id', './file.pdf');
```

### Technical Debt Addressed

- [x] Removed hardcoded values (domain, root path, locale)
- [x] Separated API logic from Box Drive logic
- [x] Removed tight coupling to Playwright
- [x] Made sync verification more robust
- [x] Eliminated code duplication
- [x] Added proper type safety throughout

### Testing Considerations

Need to test:

- [ ] Auto-detection of Box Drive root on Windows/Mac/Linux
- [ ] All three sync strategies (`poll`, `smart`, `force`)
- [ ] Token persistence and auto-load
- [ ] Backward compatibility with existing code
- [ ] Date folder creation with different locales
- [ ] Chunked upload for large files
- [ ] Box Drive health check

### Documentation

Updated README.md with:

- Architecture diagram
- Configuration options
- Sync strategies explanation
- API reference for all three layers
- Migration examples

### Performance Improvements

- Async constructor doesn't block on token loading
- Lazy initialization where possible
- Smart sync reduces unnecessary polling

### Security Improvements

- clientSecret never stored (only in memory from env/config)
- Proper file permissions for token storage (0o600)
- Token storage path follows platform conventions

### Future Enhancements

Potential improvements for future iterations:

- Add sync conflict detection
- Support for selective sync folders
- More granular Box Drive status checks
- WebSocket-based sync notifications (if Box API supports)
- Retry logic for failed uploads
- Progress callbacks for large uploads

---

**Time Invested:** ~4 hours
**Lines of Code:** ~1200 (new), ~600 (refactored)
**Files Modified:** 6 new, 2 refactored
**Breaking Changes:** 0 (fully backward compatible)
